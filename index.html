<!DOCTYPE html>
<html>
	<head>
		<style>

			* { box-sizing: border-box; }

			.container { font: 14px verdana, arial, sans-serif; }

			.playercolor {
				height: 60px;
			}

			.board { position: relative; }
			.tile {
				width: 50px;
				height: 50px;
				position: absolute;
				background: #eee;
				transition: background 0.2s ease;
				text-align: center;
				font-size: 26px;
				line-height: 50px;
				font-family: verdana, arial, sans-serif;
				color: #fff;
			}

			.board .tile:hover {
				opacity: 0.5;
			}

			.tile.selected {
				opacity: 0.7;
			}

			.tile[playerindex="1"] {
				background: #ff3333;
			}

			.tile[playerindex="2"] {
				background: #3333ff;
			}

		</style>
		<script src="js/jquery-1.9.0.min.js"></script>
		<script src="js/tal.js"></script>
		<script src="js/talCssRenderer.js"></script>
		<script>
			$(function() {
				// Game and renderer
				window.talGame = new TalGame();
				var talRenderer = new TalCssRenderer($(".board"));

				// Settings
				talGame.playerCount(2);
				talGame.boardSize({width:10,height:10});

				// Error message, if any
				var error;

				// Players
				var humanPlayer = (function() {
					return {
						doMove : function(board, playerIndex, previousMove) {
							// Notify player that he can move
							$(".status").html(error || "Your turn, player " + playerIndex + ". Your color is");
							$(".playercolor").html("<div class='tile' playerindex='" + playerIndex + "'></div>");
							error = null;
							// Wait for player input
							var deferred = new $.Deferred();
							talRenderer.on("playerInput", function(move) {
								deferred.resolve({
									from : {x:move.from.x, y:move.from.y},
									to : {x:move.to.x, y:move.to.y}
								});
							})
							return deferred.promise();
						}
					}
				})();
				var willemSimpleBot = (function() {
					return {
						doMove : function(board, playerIndex, previousMove) {
							var deferred = new $.Deferred();
							if (error) {
								$(".status").html(error + ". Whoops, this bot is stupid. This game ends now I guess...");
								talGame.giveUp(playerIndex);
								return deferred.promise();
							}
							// Notify player that he can move
							$(".status").html("Computer (player " + playerIndex + ") is moving. His color is");
							$(".playercolor").html("<div class='tile' playerindex='" + playerIndex + "'></div>");
							error = null;

							// Strategy:
							// 1. If we can get the king, do it
							// 2. If our king is attacked, move it to a safe place
							// 3. Calculate the 'totalOtherPlayerAttack' and 'totalDekking'. Do the move that minimises the other player's attack and maximizes the dekking. Also calculate the 'totalOtherPlayerForce' and minimize that (i.e. take its pieces!)
							// 4. Also take into account those pieces away that are hard attacked but not dekked

							// Get some stats and make a move!
							var pieces = talGame.piecesForPlayer(playerIndex);
							
							// ===
							// Other players force
							// ===
							// Find out the total force of the other player
							var otherPlayerPieces = talGame.piecesForPlayer(playerIndex === 1 ? 2 : 1);
							var currentTotalForce = 0;
							$.each(otherPlayerPieces, function(index, piece) {
								if (!piece.taken) {
									currentTotalForce += piece.number;
								}
							});

							// ===
							// Are we under attack?
							// ===
							var otherPlayerPieces = talGame.piecesForPlayer(playerIndex === 1 ? 2 : 1);
							var currentTotalAttack = 0;
							$.each(pieces, function(index, piece) {
								var attackingPieces = talGame.dekkingPiecesForPiece(piece, otherPlayerPieces);
								if (attackingPieces.length) {
									currentTotalAttack += piece.number; // A higher number under attack is worse
								}
							});

							// === 
							// Dekking
							// ===
							// Find out which move leads to the highest 'dekking' (i.e. the cumulative amount of defense for all pieces)
							var currentTotalDekking = 0;
							$.each(pieces, function(index,piece) {
								var dekkingPieces = talGame.dekkingPiecesForPiece(piece);
								currentTotalDekking += dekkingPieces.length;
							});
							
							// ===
							// Calculate all possible moves and their results
							// ===
							var highestMove;
							var highestMoveDekking = 0;
							var lowestTotalForce = 9999999999;
							var lowestTotalAttack = 9999999999;
							var highestTotalFactor = -100000; // A combination of dekking, force etc. Higher is better for us

							var currentSituationBoard = talGame.board();
							$.each(pieces, function(index,piece) {
								var allowedMoves = talGame.allowedMovesForPiece(piece);
								$.each(allowedMoves, function(index2, allowedMove) {
									var newSituation = talGame.situationAfterMove(allowedMove, currentSituationBoard);
									// ==
									// Force
									// ==
									var newTotalForce = 0;
									var kingPresent = false;
									// If their king is gone, force is 0!
									var otherPlayerPieces = newSituation.pieces[playerIndex === 1 ? 2 : 1];
									$.each(otherPlayerPieces, function(index, piece) {
										if (!piece.taken) {
											newTotalForce += piece.number;
											if (piece.type === "k") {
												kingPresent = true;
											}
										}
									});
									if (!kingPresent) {
										newTotalForce = 0;
									}
									if (newTotalForce < lowestTotalForce) {
										lowestTotalForce = newTotalForce;
									}

									// ==
									// Attack
									// ==
									var newTotalAttack = 0;
									$.each(newSituation.pieces[playerIndex], function(index, newSituationPiece) {
										var attackingPieces = talGame.dekkingPiecesForPiece(newSituationPiece, otherPlayerPieces, newSituation.board);
										if (attackingPieces.length) {
											newTotalAttack += newSituationPiece.number; // A higher number under attack is worse
										}
									});
									if (newTotalAttack < lowestTotalAttack) {
										lowestTotalAttack = newTotalAttack;
									}

									// ==
									// Dekking
									// ==
									var newTotalDekking = 0;
									$.each(newSituation.pieces[playerIndex], function(index3, newSituationPiece) {
										var dekkingPieces = talGame.dekkingPiecesForPiece(newSituationPiece, newSituation.pieces[playerIndex], newSituation.board);
										newTotalDekking += dekkingPieces.length;
									});

									// ==
									// Total
									// ==
									// If total is higher than we encountered thus far, save it
									// We find totalForce 4 times more important
									var totalFactor = 
										(currentTotalForce === 0 ? 0 : (currentTotalForce - newTotalForce)/currentTotalForce*4) + // percentage decrease in other player's force * 4
										(currentTotalAttack === 0 ? 0 : (currentTotalAttack - newTotalAttack)/currentTotalAttack*2) +
										// percentage decrease in attack by other player * 2
										(newTotalDekking - currentTotalDekking)/currentTotalDekking // percentage increase in dekking
									if (totalFactor > highestTotalFactor) {
										highestTotalFactor = totalFactor;
										highestMove = allowedMove;
									}
								});
							});
							// Check highest dekking
							//console.log("CURRENT", currentTotalDekking);
							//console.log("HIGHEST", highestMoveDekking, highestMove);
							console.log("current force", currentTotalForce);
							console.log("lowest force", lowestTotalForce);
							console.log("current attack", currentTotalAttack);
							console.log("lowest attack", lowestTotalAttack);
							console.log("best move", highestMove);
							deferred.resolve(highestMove);
							return deferred.promise();
						}
					}
				})();

				// Bottom is human player, top is bot
				talGame.player(1, willemSimpleBot);
				talGame.player(2, humanPlayer);

				// Ensure rendering after a player moved
				talGame.on("validPlayerMove", function() {
					var board = talGame.board();
					// Render board
					talRenderer.render(board);
				});

				talGame.on("invalidPlayerMove", function(move, reason) {
					error = reason + ". Try again please.";
				});

				talGame.on("aPlayerHasWon", function(playerIndex) {
					alert("hooray, player " + playerIndex + " has won!");
				});

				// Start the game
				// Will automatically create a board of boardSize.width * boardSize.length and let the first player do its move
				talGame.start();

				// Render first situation
				talRenderer.render(talGame.board());
			});
		</script>
	</head>
	<body>
		<div class='container'>
			<div class='rules'>
				<p><strong>Tal</strong> is a turn-based game. It is easy to learn (only 4 rules) but quite hard to master.</p>
				<ol>
					<li>
						Each player must move exactly one piece each turn, in a straight line over open (i.e. non-occupied) tiles. It is not allowed to <em>not</em> move at all.
					</li>
					<li>
						The maximum amount of tiles that a piece can be moved, depends on the number on the piece. A 1 can move only 1 tile, but e.g. a 5 can move 1,2,3,4 or 5 tiles.
					</li>
					<li>
						Pieces with an odd number (1,3,5 etc) can only move diagonally while pieces with an even number (2,4,6 etc) can only move vertically or horizontally.
					</li>
					<li>
						Players can take the pieces of other players by ending a <em>forward move</em> on a tile with a piece of the other player. One cannot take pieces by moving their own piece backwards. The only exception is the king, which is a '1' piece that can take pieces by moving forward <em>or</em> backward. If a king itself is taken, the game is over and the player without king loses.
					</li>
				</ol>
			</div>
			<h2>Try it yourself</h2>
			<div class='status'>

			</div>
			<div class='playercolor'>
			</div>
			<div class='board'>
				
			</div>

		</div>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-258109-17', 'github.com');
		  ga('send', 'pageview');
		</script>
	</body>
</html>